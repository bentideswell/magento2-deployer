# Magento
MAGE_DEPLOY_STATIC_ASSETS_LOCALE="en_GB"
MAGE_MODE=production

# PHP
PHP_MEMORY_LIMIT=2G
PHP_VERSION=8.2

# Deploy
SHARED_FILES_LIST=""

# Reload PHP
function _do_php_reload {
    _do_php_reload_before
    if [ -f "bin/sweep-floor" ]; then
        bin/sweep-floor
    fi
    _do_php_reload_opcache
    _do_php_reload_after
}

function _do_php_reload_before {
    :
}

function _do_php_reload_opcache {

    _do_title "Reset OPCache"

    CURRENT_RESOLVED=$(readlink "${PATH_CURRENT}")

    _do_titled_point "Target" "${CURRENT_RESOLVED}"

    if [ ! -z "${CURRENT_RESOLVED}" ]; then
        OPCACHE_RESET_CONTENT="<?php header('Content-Type: text/plain;charset=utf-8');echo opcache_reset() ? \"OPCache Reset\":\"Opcache not reset\";"
        OPCACHE_RESET_FILENAME="opcache-reset.php"
        OPCACHE_RESET_FILE="${PATH_BASE}/${CURRENT_RESOLVED}/pub/${OPCACHE_RESET_FILENAME}"

        _do_titled_point "OPCache Reset" "${OPCACHE_RESET_FILE}"
        echo "${OPCACHE_RESET_CONTENT}" > "${OPCACHE_RESET_FILE}"
        _do_line_break
        curl -sSk "${MAGE_BASE_URL}/${OPCACHE_RESET_FILENAME}"
        _do_line_break
        rm "${OPCACHE_RESET_FILE}"
    else 
        _do_point "Current symlink empty so skipping"
    fi
}

function _do_php_reload_after {
    :
}
