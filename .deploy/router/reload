#!/usr/bin/env bash
#
# Options
#
# --dry-run

_do_title "Reload PHP-FPM"

OS="$(uname -s)"

_do_titled_point "OS:" "${OS}"

RESTART_DONE=0

if [ "$OS" = "Linux" ]; then
    if command -v systemctl >/dev/null 2>&1; then
      SERVICE="$(systemctl list-units --type=service --no-pager | awk '/php.*fpm.*service/ { print $1; exit }')"
      if [ -n "$SERVICE" ]; then
        echo "Using systemctl reload $SERVICE"
        sudo systemctl reload "$SERVICE"
        return
      fi
    fi

    echo "Falling back to USR2 signal"
    for pid in $(pgrep -f 'php.*fpm: master'); do
      sudo kill -USR2 "$pid"
    done
elif [ "$OS" = "Darwin" ]; then
    if command -v brew >/dev/null 2>&1; then
        SERVICE="$(brew services list 2>/dev/null | awk '/php(@[0-9.]+)?/ && $2=="started" { print $1; exit }')"
    
        if [ -n "$SERVICE" ]; then
            _do_titled_point "PHP-FPM:" "${SERVICE}"
            _do_line_break
            brew services restart "${SERVICE}"
            RESTART_DONE=1
        fi
    fi

    if [ "$RESTART_DONE" -eq 0 ]; then
        _do_titled_point "CMD:" "kill -USR2"

        for pid in $(pgrep -f 'php.*fpm: master'); do
            _do_titled_point "PID:" "${pid}" 
            kill -USR2 "$pid"
            RESTART_DONE=1
        done
    fi
else
    _do_error "Unsupported OS: $OS"
fi

if [ "$RESTART_DONE" -eq 0 ]; then
    _do_error "Unable to reload PHP-FPM automatically"
else
    _do_line_break
    _do_point "PHP-FPM reload complete"
    _do_line_break
fi